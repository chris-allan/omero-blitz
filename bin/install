#!/bin/bash
#
# OMERO Grid Install Script
# Copyright 2008 Glencoe Software, Inc.  All Rights Reserved.
# Use is subject to license terms supplied in LICENSE.txt
#

OMERO_HOME=${OMERO_HOME:-"."}

_install(){
    OUTPUT=$1
    RC=$2
    if echo $OUTPUT | grep "could not contact" >/dev/null; then
        echo Server not found.
        echo Did you run start?
        return 1
    elif echo $OUTPUT | grep "already exists" >/dev/null; then
        echo Already installed.
        echo Delete $OMERO_HOME/var/registry and
        echo $OMERO_HOME/var/master,
        echo then restart to install.
        return 1
    elif [ $RC -ne 0 -a -n "$OUTPUT" ]; then
        echo "Unknown error:"
        echo $OUTPUT
        return 1
    else
        return 0
    fi
}

OUTPUT=`$OMERO_HOME/bin/admin.sh -e "application add $OMERO_HOME/etc/grid/default.xml $*" 2>&1`
RETCODE=$?

_install "$OUTPUT" "$RETCODE"
